<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>Bayesian Estimation Supersedes the t-test (BEST) - Online</title>
<link rel="stylesheet" href="css/squaregrid.css" />

<style type="text/css">
.legendLabel {
  font-size:11px; line-height:0px; 
}
.item_title, .item_description { 
    font-size:14px; line-height:125%; text-align: center;
}
.about { 
    font-size:14px; line-height:125%; text-align: center; color: gray;
}
body { font-family: sans-serif; background-color:#f4f4f4; font-size:15px; line-height:18px; }
</style>
<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="js/jquery.flot.min.js"></script>
<script type="text/javascript" src="js/jstat.js"></script>
<script type="text/javascript" src="js/js_mcmc.js"></script>
<script type="text/javascript" src="js/plot.js"></script>
<script type="text/javascript">

    var burn_timeout_id
    var sample_timeout_id
    var plot_timeout_id
    
    $(document).ready(function() {
        $("#diff_plots_div").hide();
        $("#more_results_wrapper_div").hide();
        
    });
    
    function write_log(s) {
        $("#log").val($("#log").val() + s)
        $("#log").scrollTop($("#log")[0].scrollHeight);
    }

    function run_BEST() {
        write_log("\n")
        window.clearTimeout(burn_timeout_id)
        window.clearTimeout(sample_timeout_id)
        window.clearTimeout(plot_timeout_id)
        $("#start_button").html('Click to restart!');

        y1 = string_to_num_array($("#data_group_1").val())
        y2 = string_to_num_array($("#data_group_2").val())

        try {
            jStat.map(y1.concat(y2), function(x) {if(x - 0 != x) throw "ERROR"})
        } catch(err) {
            write_log("ERROR: Data not supplied for both groups or not formatted correctly.\n")
            return
        }

        var n_samples = parseInt($("#nbr_of_samples_input").val()) + 10
        var n_burnin = parseInt($("#nbr_of_burnin_input").val())




        if(n_samples < 1 || n_burnin < 1 || n_samples - 0 != n_samples || n_burnin - 0 != n_burnin) {
            write_log("ERROR: Nbr of burn-in samples and nbr of regular samples should be > 1, right?\n")
            return
        }

        var posterior = make_BEST_posterior_func(y1, y2)

        // Function to calculate some more statistics from the chain
        var data_calc = function(params) {
            var mu_diff = params[0] - params[1]
            var sd_diff = params[2] - params[3]
            var effect_size = (params[0] - params[1]) / Math.sqrt((Math.pow(params[2], 2) + Math.pow(params[3], 2)) / 2 )
            var normality = Math.log(params[4]) / Math.LN10
            return [mu_diff, sd_diff, normality, effect_size]
        }

        var inits = [jStat.mean(y1), jStat.mean(y2), jStat.stdev(y1), jStat.stdev(y2), 5]

        var sampler = new amwg(inits, posterior, data_calc)

        function burn_asynch(n) {
            sampler.burn(500)
            write_log("*")
            if(n > 0) {
                burn_timeout_id = setTimeout(function() {burn_asynch(n - 1)}, 0)
            } else {
                write_log("\n-- Finished Burn in phase --\n")
                write_log("\n-- Started sampling phase --\n")
                $("#diff_plots_div").show();
                sample_timeout_id = sampler.n_samples_asynch(n_samples, 50)
                plot_asynch()
            }
        }
        

        function plot_asynch() {
            var plot_start_time = new Date()
            var chain = sampler.get_chain()
            var plot_data = chain_to_plot_data(chain, Math.ceil(n_samples / 1000))
            plot_mcmc_chain("group_diff_plot", plot_data[5], "samples")
            //plot_mcmc_chain("plot3", plot_data[2] , "title2")
            //plot_mcmc_chain("plot5", plot_data[4], "title3")

            plot_mcmc_hist("group_diff_hist", param_chain(chain, 5), true, 0)
            //plot_mcmc_hist("plot4", param_chain(sampler.get_chain(), 2), true)
            //plot_mcmc_hist("plot6", param_chain(sampler.get_chain(), 4), true)
            
            var plot_time = (new Date()) - plot_start_time
            if(sampler.is_running_asynch()) {
                plot_timeout_id = setTimeout(function() {plot_asynch()}, plot_time * 2 )
            } else {
                write_log("\n -- Finished sampling phase --\n ")
                write_log("-- Results plotted below --\n ")
            }
        }

        write_log("-- Started Burn in phase --\n")
        burn_asynch(Math.ceil(n_burnin /  500))
    }
</script>
</head>

    <body>

    <div id="wrapper"><!-- you need both the wrapper and container -->
        <div id="container">
        
            <!-- Just an example of a layout, so you can see how it works. -->
            <!-- Please delete this line once you're done. <style>#example-a, #example-b, #example-c, #example-d1, #example-d2{background:yellow; height:800px; margin-top:14px;filter:alpha(opacity=30); -moz-opacity:0.3; -khtml-opacity: 0.3; opacity: 0.3;}</style>-->
            <div id="title_div" class="sg-35" style="margin: 0 14px 0px"><h1>Bayesian Estimation Supersedes the t-test (BEST) - online</h1></div>
            <div id="data_and_log_div" class="sg-35 sgParent">
                <div id="title_and_instructions_div" class="sg-23 borderRight">
                    
                    <p>
                       Some text
                    </p>
                </div>
                <div id="log_wrapper_div" class="sg-10"> <br/><br/><div class="item_title">Log</div><textarea id="log" style= "width: 100%; height: 250px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; " ></textarea></div>
            </div>
            
            <div id="data_group_1_div" class="sg-5">
                <!-- Lengths of the winners of the 2012 NBA Finals, Miami Heat. -->
                <div class="item_title">Data group 1</div><textarea id="data_group_1" style= "width: 100%; height: 100px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; " >1.96 2.06 2.03 2.11 1.88 1.88 2.08 1.93 2.03 2.03 2.03 2.08 2.03 2.11 1.93</textarea>

                <!-- Lengths of 2012 Stanley cup winners, Los Angeles Kings. -->
                <div class="item_title">Data group 2</div><textarea id="data_group_2" style= "width: 100%; height: 100px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; " >1.83 1.93 1.88 1.85 1.85 1.91 1.91 1.85 1.78 1.91 1.93 1.80 1.80 1.85 1.93 1.85 1.83 1.85 1.91 1.85 1.91 1.85 1.80 1.80 1.85</textarea>
            </div>

            <div id="start_button_div" class="sg-7">
                <img src="images/instructions.png"/>
                <div class="item_title">Nbr of burn-in samples</div>
                <input id="nbr_of_burnin_input" type="text" name="nbr_of_burnin" style="width: 100%;" value = "20000"/>
                <div class="item_title">Nbr of samples</div>
                <input id="nbr_of_samples_input" type="text" name="nbr_of_samples" value = "20000" style="width: 100%;"/>
                <button id="start_button" type="button" onclick="run_BEST()" style="width: 100%; height: 40px">Click to start!</button>
            </div>
            
            <div id="diff_plots_div">
                <div id="group_diff_plot_wrapper_div" class="sg-8">
                     <div class="item_title">Trace Plot - Difference of Means</div>
                    <div id="group_diff_plot" style="height: 200px;"></div> 
                    <div class="item_description">Should look like a "hairy caterpillar"...</div>
                </div>
                <div id="group_diff_hist_wrapper_div" class="sg-11">
                     <div class="item_title">Distribution - Difference of Means</div>
                    <div id="group_diff_hist" style="height: 200px;"></div>
                    <div class="item_description">If the 95% Highest Density Interval does not include zero there is a credible difference!</div>
                </div>
            </div>
            <div class="sg-35 about "></div>
            <div class="sg-35 about "><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Coded by <a xmlns:cc="http://creativecommons.org/ns#" href="http://sumsar.net/" property="cc:attributionName" rel="cc:attributionURL">Rasmus Bååth</a> 2012.<br/> Licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</div>
            
        </div><!-- end #container -->

    </div><!-- end #wrapper -->

</body>
</html>
